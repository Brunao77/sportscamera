---
import Layout from "../../layouts/Layout.astro"
import Input from "../../components/Input.astro"
import Button from "../../components/Button.astro"
import Password from "../../icons/Password.astro"
import Success from "../../components/Success.astro"
import Error from "../../components/Error.astro"

const { token } = Astro.params
---

<Layout>
    <form method='POST' class="bg-white flex flex-col items-start justify-center px-12 py-10 rounded-xl w-full gap-5 h-full md:h-fit" id="change_password">
		<strong class="text-2xl text-primary">Elige una contraseña nueva</strong>
		<p class="text-wrap max-w-96">Asegúrate de que tu contraseña tenga 5 caracteres o más. Intenta que incluya números, letras y signos de puntuación para que sea una contraseña segura.</p>
        <Input placeholder="Contraseaña" name="password" id="password_inp" minlength="5" required>
            <Password />
        </Input>
        <span class="text-center text-red-500 text-sm hidden" id="errorSpan"></span>
        <Button type="submit" id="change_password_btn">
            <span id="content_btn">CAMBIAR CONTRASEÑA</span>
            <div class='w-6 h-6 border-4 border-ice border-l-transparent rounded-full animate-spin hidden' id="spinner"></div>
        </Button>
    </form>
	<Success message="Contraseña reestablecida" hidden={true}/>
	<Error message="Token invalido" hidden={true}/>
	<script is:inline define:vars={{ token }}>
	
		document.addEventListener('astro:page-load', () => {

			const form = document.getElementById('change_password')

			form.addEventListener('submit', async function(event){
				event.preventDefault();
	
				const loginBtn = document.getElementById('change_password_btn')
				const buttonContent = document.getElementById('content_btn');
				const spinner = document.getElementById('spinner');
				
				loginBtn.disabled = true
	
				buttonContent.classList.add('hidden');
				spinner.classList.remove('hidden');
				
				const formData = new FormData(this);
				
				const formDataObject = {};
				formData.forEach((value, key) => {
					formDataObject[key] = value;
				});
	
				const inputs = form.querySelectorAll('input');
				inputs.forEach(function(input) {
					input.disabled = true;
				});			
	
				try {
					const response = await fetch(`/api/reset-password/${token}`, {
						method: 'POST',
						body: JSON.stringify(formDataObject)
					});
					if (response.ok) {
						const successToast = document.getElementById('success_toast')
						successToast.classList.remove('hidden');
						setTimeout(() => {
							window.location.href = response.headers.get('Location')
						}, 2000);
						
					}else {
						if(response.status === 401){
							console.log('asdas')
							const errorToast = document.getElementById('error_toast')
							errorToast.classList.remove('hidden');
							setTimeout(() => {
								window.location.href = response.headers.get('Location')
							}, 2000);
						}

						const res = await response.json()

						const errorSpan = document.getElementById('errorSpan');
						errorSpan.textContent = res.message
						errorSpan.classList.remove('hidden');
	
						inputs.forEach(function(input) {
							input.disabled = false;
						});
	
						loginBtn.disabled = false
						spinner.classList.add('hidden');
						buttonContent.classList.remove('hidden');
					}
				} catch (error) {
					console.error('Error en la solicitud:', error);
				}
			});
		}, { once: true })
	</script>
</Layout>