---
import Layout from '../../layouts/Layout.astro'
import Input from '../../components/Input.astro'
import Button from '../../components/Button.astro';
import Email from '../../icons/Email.astro';
import { ViewTransitions } from "astro:transitions";
import { UserModel } from '../../models/user.js';
import { createPasswordResetToken, sendPasswordResetToken } from "../../utils";

const user = Astro.locals.user;
if (user) {
	return Astro.redirect("/video-list");
}

if(Astro.request.method === 'POST'){
    try {
        const data = await Astro.request.formData();
        const email = data.get("email");

        const result = await UserModel.findWithEmail({ email })

        if (!result)
            return new Response(JSON.stringify({message: 'Email invalido'}),{status:400}) 

        const verificationToken = await createPasswordResetToken(result.user_id);
        const verificationLink = import.meta.env.URL + "/password_reset/" + verificationToken;

        const statusEmailSent = await sendPasswordResetToken(email, verificationLink);

        if(statusEmailSent === 500) return new Response(JSON.stringify({message: 'Error sending email'}),{status:400}) 

        return new Response(JSON.stringify({message: 'Check your email for instructions on resetting your password'}),{status:200})
    } catch (error) {
        console.error(error.message);
    }
}
---

<Layout>
	<form method="POST" class="bg-white flex flex-col items-center justify-between p-2 rounded-xl w-full" id="sendEmail">
        <div class="flex flex-col items-center gap-4 text-center">
            <strong class="text-2xl text-primary">Recupera tu cuenta de SportsCamera</strong>
            <p>Introduce el correo electrónico asociado a tu cuenta para cambiar tu contraseña.</p>
            <Input name="email" placeholder="Email" type="email" required>
                <Email />
            </Input>
        </div>
        <Button type="submit">SIGUIENTE</Button>
    </form>
</Layout>