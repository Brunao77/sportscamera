---
import Layout from '../layouts/Layout.astro'
import Input from '../components/Input.astro'
import Button from '../components/Button.astro';
import Email from '../icons/Email.astro';
import Password from '../icons/Password.astro';

const user = Astro.locals.user;
if (user) {
	return Astro.redirect("/video-list");
}

---

<Layout title="SportsCamera!">
	<section class="bg-white h-full md:rounded-l-xl md:rounded-br-none flex flex-col gap-5 items-center justify-center px-20 py-20">
		<strong class="text-5xl text-primary font-medium text-nowrap">Iniciar Sesion</strong>
		<form method="POST" class="flex flex-col gap-4" id="loginForm">
			<Input placeholder="Usuario" name="email" required type="email">
				<Email />
			</Input>
			<Input placeholder="Contraseña" name='password' required type="password" minlength="5">
				<Password />
			</Input>
			<span class="text-center text-red-500 text-sm hidden" id="errorSpan"></span>
			<Button type="submit" id="login_btn">
				<span id="content_btn">INICIAR SESION</span>
				<div class='w-6 h-6 border-4 border-ice border-l-transparent rounded-full animate-spin hidden' id="spinner"></div>
			</Button>
		</form>
		<a class="text-terciary cursor-pointer" href="/password_reset">¿Olvidaste tu contraseña?</a>
		<a class="text-terciary cursor-pointer" href="/contact">Contactanos!</a>
	</section>
    <section class="bg-primary text-white text-center flex flex-col items-center justify-center  md:rounded-r-xl md:rounded-tl-none gap-5 py-4 md:py-0">
		<h1 class="font-medium text-5xl">SportsCamera!</h1>
		<p class="m-0 font-light text-l w-3/4">Servicio de grabacion en establecimientos deportivos</p>
		<a class="rounded-2xl border p-3" href="/">BUSCAR VIDEO</a>
	</section>
</Layout>
<script is:inline>
	document.addEventListener('astro:page-load', () => {
		const form = document.getElementById('loginForm')
		form.addEventListener('submit', async function(event){
			event.preventDefault();

			const loginBtn = document.getElementById('login_btn')
			const buttonContent = document.getElementById('content_btn');
			const spinner = document.getElementById('spinner'); 

			
			loginBtn.disabled = true

			buttonContent.classList.add('hidden');
			spinner.classList.remove('hidden');
			
			const formData = new FormData(this);

			const formDataObject = {};
			formData.forEach((value, key) => {
				formDataObject[key] = value;
			});

			const inputs = form.querySelectorAll('input');
			inputs.forEach(function(input) {
				input.disabled = true;
			});
			

			try {
				console.log('ingreso')
				const response = await fetch('/api/user/login', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(formDataObject)
				});
				if (response.status === 200) {
					console.log('ok')
					window.location.href = '/video-list';
					
				} else {
					const res = await response.json()
					const errorSpan = document.getElementById('errorSpan');
					errorSpan.textContent = res.message
					errorSpan.classList.remove('hidden');
					inputs.forEach(function(input) {
						input.disabled = false;
					});
					loginBtn.disabled = false

					spinner.classList.add('hidden');
					buttonContent.classList.remove('hidden');
				}
			} catch (error) {
				console.error('Error en la solicitud:', error);
			}
		});
	}, { once: true })
</script>
<style>
	.search_video{
		width: 40%;
		background-color: #9F4AA0;
		text-align: center;
		display:flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		color: #fff;
		border-radius: 0 10px 10px 0;
		gap:20px;
		& h1{
			font-weight: 600;
			font-size: xxx-large;
			margin:0;
		}
		& p{
			margin:0;
			width:200px;
			font-weight: lighter;
			font-size: medium;
		}
		& a{
            text-decoration: none;
			cursor: pointer;
			width: 200px;
			height: 50px;
			border-radius: 30px;
			text-align: center;
			background-color: transparent;
			border: solid 1px #fff;
			color:#fff;
		}
	}
</style>
